## 다중화의 기본

### 다중화란
- 장애가 발생해도 예비 운용장비로 시스템 기능을 계속할 수 있는 것

### 다중화의 본질
- 장애를 상정하고, 장애에 대비해 예비 운용 장치 운용을 통해 교체하거나 대응할 수 있는 운용체제를 정비하는 것
- Cold standby
  - 예비 운용 장비는 보통 사용하지 않고 현재 운용장비에 장애가 발생하면 예비 운용장비를 연결하는 운용체제

- Hot standby
  - 예비 운용 장비를 항상 운용하고 있어, 장애가 발생하면 즉시 예비 운용장비로 전환하는 운용체제

### 장애극복 (FailOver)
- 현재 운용장비에 장애가 발생했을 때 자동적으로 예비 운용장비로 처리를 인계하는 것
- 서버를 장애 극복하기 위해서는 가상 IP주소(VIP)와 IP주소 인계를 이용
- VIP(Virtual IP Address)
  - Active/Backup
    - 현재 운용장비와 별도의 가상 IP를 만들어 웹서버를 인계하고 장애 발생시 대응하는 예비 운용장비를 통해 인계하는 방식


### 장애 검출 - 헬스체크
- 정상적으로 장애 극복하기 위해 현재 운용장비에서 장애가 발생하고 있음을 검출하는 방법이 필요
- 이 방법을 헬스체크라 함
- 용도에 따라 적절한 종류를 선택
  - ICMP 감시 (Layer 3)
    - ICMP의 echo 요청을 보내 응답이 돌아오는 지 체크
    - 가장 간단하고 가벼운 헬스체크 지만 웹서비스가 다운 된 경우 감지 불가 
  - 포트 감시 (Layer 4)
    - TCP로 접속을 시험해 접속할 수 있는지 테스트.
    - 웹 서비스가 다운된 것은 감지할 수 있지만 과부화로 응답할 수 없거나 에러 반환하는 것은 감지 불가
  - HTTP 감시 (Layer 7) 
    - 실제 HTTP 요청을 보내 정상적인 응답이 돌아오는 지 체크.
    - 대부분의 이상을 감지할수 있지만 경우에 따라 서버에 부하 줄 수 있음

- 웹서버의 헬스체크
  - 서버 장애에 의한 서비스 중지를 정상적으로 검출하기 위해서는 서비스 감시를 이용
  - 서버의 전원이 켜져있어 ICMP의 응답이 돌아오더라도 웹서비스가 정상적으로 동자갛고 있다고 할 수 없기 때문

- 라우터의 헬스체크
  - ICMP 감시를 이용할 수 있음
  - 라우터가 확실히 패킷을 전송할 수 있는가라는 것 - 웹서버가 인터넷과 통신할 수 있는 상태인지 확인

- 헬스체크를 할때는 무엇을 확인하려고 하는 것인가가 중요


### Active/Backup 구성 만들기
- 아래의 파일로 failover 테스트
- failover.sh
  ```shell
  #!/bin/sh
  VIP="10.0.0.1"
  DEV="eth0"
  
  healthcheck(){
    ping -c -1 -w 1 $VIP > /dev/null
    return $?
  }
  
  ip_takeover(){
     MAC='ip link show $DEV | egrep -o "([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}"'|
        ifconfig $DEV downhead -n 1 | tr -d :'
  ip addr add $VIP/24 dev $DEV
  send_arp $VIP $MAC 255.255.255.255 fffffffff
  }
  
  while healthcheck; do
  echo "health ok!"
  sleep 1
  done
  echo "fail over!"
  ip_takeover
  ```
  
- VIP에 대해 1초마다 ping 검사를 수행해 실패하면 서버에 VIP를 할당하는 스크립트
- Web1에 해당 스크립트를 실행하면 fail over!라는 문자열을 출력하고 종료함 -> Web1에 VIP가 할당됨
- Web2에 해당 스크립트를 실행하면 health ok!라는 문자열이 1초마다 계속 표시됨
- 클라이언트에서 VIP에 대해 ping 감시를 하면서 Web1을 shutdown하면 web2에서 실행 중인 스크립트의 헬스체크가 실패하면서 VIP를 인계함
- 클라이언트의 ping 감시는 web1을 shutdown한 후 3초 정도만에 IP주소가 인계됨을 확인할 수 있음

#### IP 주소를 인계하는 원리
- IP주소 인계란 단순히 IP주소를 바꿔서 설정하는 것뿐이 아님
- LAN의 세계에서는 IP주소가 아닌 NIC에 고정적으로 할당되어 있는 MAC주소를 사용해서 통신함
- 다른 서버에 패킷을 보낼 때는 MAC 주소를 얻기 위해 ARP(Address Resolution Protocol)이라는 프로토콜을 이용함
- ARP는 IP주소를 지정해서 MAC주소를 조회하기 위한 프로토콜
- 그러나 통신할때마다 조회하는 것은 효율이 좋지 않으므로 ARP 테이블에 이를 일정기간 캐싱함
- 따라서 다른 서버에 같은 IP주소가 할당되더라도 ARP 테이블이 갱신되기 까지는 그 서버와 통신할 수 없음
- 즉 IP주소를 인계하기 위해서는 다른 서버의 ARP 테이블을 갱신해주어야 함.
- gratutious ARP 통상의 요청과 다르게 내 IP주소와 MAC 주소는 이것이다 라고 다른 서버에 통지하기 위한 것
- 위 sh 파일에서는 send_arp라는 명령을 통해 gratutious ARP를 전송함

#### 서버를 효과적으로 활용하자
- 예비 운용장비를 얌전히 Backup으로 대기하게 해놓는 것은 아까운 상황
- 두대 서버를 이용한다면 전체 처리성능이 배가 될 것이기 때문
- 여러 대 서버에 처리를 분산시켜 사이트 전체의 확장성을 향상시키는 방법을 부하분산(로드밸런스)라고 함
- 웹 서버를 부하분산 구성으로 하면 앞으로 접속수가 늘어나서 서버의 처리가 따라가지 못하더라도 서버를 증성함으로써 대응할 수 있게 됨


